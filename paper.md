基于机器学习的流量识别技术
一、  课题背景与意义
1.1  研究背景
随着互联网技术的持续演进和网络应用的多样化，网络流量的复杂性日益增强。传统的流量识别方法，主要基于端口号和特定特征，面临着众多挑战。例如，动态端口使得基于端口的流量识别不再可靠，加密传输使得内容深度检测受限，以及复杂的应用层协议增加了识别的难度。鉴于此，为维护网络的安全性和提高管理效率，开发新型的流量识别策略变得尤为关键。
近年来，机器学习已在多个领域展现出其在模式识别和数据分析上的卓越性能。考虑到网络流量识别是一个典型的数据驱动的模式识别问题，应用机器学习方法于此领域自然具有广阔的研究前景。
1.2  研究意义
提升流量识别的准确性：机器学习方法能深入挖掘大量流量数据中的潜在模式，从而显著提高流量的识别率。这在检测新兴及未被定义的网络活动，特别是针对潜伏的网络安全威胁时，具有至关重要的作用。
实现对网络环境的动态适应：与传统的基于固定规则的识别方式相比，机器学习方法能够灵活地适应网络环境的持续变化，并能够实时更新模型，以捕捉新出现的流量模式。
有效应对加密流量：随着加密通信技术的广泛应用，大部分网络流量现已采用加密方式进行传输，这为传统识别方法带来了巨大挑战。利用机器学习技术，我们可以基于加密流量的统计属性进行有效的流量分类和识别，尽管对于某些复杂的加密流量，机器学习可能仍面临识别挑战。
优化网络资源管理：准确识别流量后，网络管理员能够更有针对性地进行带宽分配、服务质量调整和策略制定，从而大幅提高网络的整体性能。
加强网络的安全防护：机器学习技术助力安全专家及早发现并拦截恶意流量，大大降低了网络遭受攻击的风险。
推动技术革新：此项研究不仅有助于进一步优化流量识别技术，同时还为机器学习在更广泛的网络安全领域内的应用积累了宝贵的经验和知识。
1.3  小结
从上述分析可以看出，基于机器学习的流量识别技术在确保网络安全、提升网络管理效率以及促进技术创新等方面，都具有不可忽视的重要价值。 
二、科研项目完成情况
2.1  总设计方案
本课题基于机器学习进行流量识别技术，由计算流量特征重要度，流量采集组成。


2.2  数据包处理
在本次实验中，我们使用Wireshark工具从链路层开始捕获数据包。为确保数据的完整性，捕获条件专门针对SYN和ACK报文，并且确保这些报文包括保留的、乱序的及重传的报文。实验结果是对九类不同应用的数据包（即pcap包）的收集。每个pcap文件都被输出到一个单独的目录中。

值得注意的是，每个pcap包含了超过一万条的网络流。在这里，我们定义一条网络流为拥有相同IP五元组（即源IP、目标IP、源端口、目标端口和协议类型）的连续网络包。为了便于分析，我们对每条网络流进行了预处理，转化为一个矩阵，并存储为一个独立的文本文件。
为确保数据的一致性和可处理性，每条网络流仅取其前32个数据包，且每个数据包仅提取其前512字节。如果某数据包不足512字节，我们使用0进行补齐。因此，每个预处理后的样本都是一个32×512的矩阵。

在对数据报内容进行深入分析后，我们识别出了矩阵中各个字段的具体结构。具体如下：
(1).第1到14字节：这部分对应于MAC帧。
(2).第15到34字节：此段是IP数据报的内容。
(3).第35到54字节：这部分内容代表TCP数据报。
(4).第55到512字节：此区域是数据字段。
2.3  机器学习模型可解释性方案
近年来，机器学习模型，特别是深度学习模型，在多种任务上都表现出了卓越的性能。从图像分类到自然语言处理，它们都已成为了解决复杂问题的首选方法。然而，尽管它们的预测能力得到了广泛的认可，这些模型的“黑箱”特性却仍然是一个挑战。具体来说，许多高级机器学习模型的决策过程缺乏透明性，这使得研究人员、实践者甚至最终用户都难以理解和信任它们的决策。
为了解决这一透明度问题，许多解释性机器学习方法应运而生。其中，Shapley值已经成为了一种颇受欢迎的方法。Shapley值，最初在博弈论中提出，旨在解释每个特征对模型预测的公平贡献。当应用于机器学习模型时，Shapley值可以为我们提供每个输入特征对模型预测的权重，从而帮助我们深入了解模型的决策机制。因此，利用Shapley值，我们不仅可以“打开”模型的黑箱，还可以提高模型的可信度和接受度。

瀑布图展示了某个病人从测试集平均结果到最终预测结果的决策过程，以及各特征对预测结果的贡献影响。
2.4  神经网络设计方案
在进行流量识别的实验中，我们面临以下主要挑战：
(1).实际应用的流量数据包种类繁多且特征丰富，这增加了分类和识别的复杂性。
(2).由于数据包信息的复杂性，单纯增加网络深度可能会导致梯度消失问题，从而影响模型的训练和性能。
(3).另外，我们还探讨了是否可以利用SHAP库对模型进行可解释性研究，从而提高模型的透明度和信赖度。
为了有效应对这些挑战，我们提出了一种解决方案：引入残差结构来构建Residual Network（通常简称为ResNet）。通过这种结构，我们可以有效地增加网络深度，同时避免梯度消失的问题，并为后续的可解释性研究打下坚实的基础。
ResNet，即残差网络，是为了解决深度学习中的梯度消失和梯度爆炸问题而提出的。这些问题通常会在非常深的网络中出现，限制了模型的深度和性能。而ResNet的核心思想是在网络中引入“跳跃连接”或称为“短路连接”。
具体来说，传统的深度神经网络中，每个层的输出会作为下一层的输入。在ResNet中，某些层的输出不仅被传递给下一层，还会跳过一个或多个层与更深层的输出相加。这种设计形成了一个“残差块”，其数学表达为：

这种结构的主要优势是，它允许梯度在训练过程中直接反向传播，从而缓解了梯度消失问题。因此，使用ResNet结构，我们可以轻松地训练上百甚至上千层的网络，而不会遇到传统深度网络中的训练困难。
2.5  Shapley特征重要度计算
为了深入探讨模型决策过程中的各个特征的重要性，我们采用了以下步骤：

数据获取：首先，我们收集了样本数据，其中每个样本是一个 32×512的矩阵。这些矩阵随后被用作训练输入。
计算单个样本的SHAP值：每个样本矩阵可以视作一个尺寸为1×32×512 的图像。为了理解每个特定“像素”对输出结果的影响，我们计算了每个像素位置的SHAP值，从而得到该像素对最终预测的贡献度。
计算测试集的SHAP值：对于测试集中的每一个样本，我们都按照上述方式计算其SHAP值，生成了一个相同的尺寸为 1×32×512的矩阵。随后，我们将这些矩阵在对应的位置上进行累加，从而得到了一个总结了所有样本的累加SHAP值的矩阵。
特征排序：我们进一步加工得到的SHAP值矩阵，以理解各个特征的相对重要性。为此，我们将每列的SHAP值进行累加，从而得到一个1×512 的矩阵，其中每个值代表了在测试集上，该特征对预测结果的总贡献度。最后，我们根据这些累计贡献度对所有特征进行排序，以确定其重要性。
2.6  基于eBPF在数据链路层抓取流量实验方案
eBPF (Extended Berkeley Packet Filter) 是近年来Linux内核中的一项革命性创新，为系统和网络性能分析、安全监控及网络路由等多个领域提供了新的编程能力。其核心是为内核提供一种安全的、高效的、基于字节码的可执行程序，这些程序可以在各种内核事件发生时动态执行。
从工作机制的角度看，eBPF程序首先在用户空间被编写和编译，然后通过特定的系统调用被加载到内核空间。在被加载到内核之前，eBPF程序必须经过一系列的验证步骤，确保其行为受限并不会对系统造成危害或不稳定。这个验证过程确保了eBPF程序不会进行无限循环、访问非法内存区域或执行其他可能破坏系统稳定性的操作。一旦程序通过验证并加载到内核，它可以被附加到各种类型的内核钩子上。这些钩子通常是与特定的内核事件相关的，例如网络包的收发、系统调用的执行或其他内核中断。当这些事件发生时，与之关联的eBPF程序就会被自动触发执行。
为了与用户空间交互，eBPF提供了称为"maps"的数据结构，这些数据结构可以被内核和用户空间同时访问。因此，eBPF程序可以在这些maps中收集数据，并由用户空间程序读取这些数据以进行进一步的分析和处理。
总体而言，eBPF为Linux内核引入了一种灵活而强大的编程机制，允许研究人员和开发者对内核事件进行深度监控和定制化处理，而无需修改内核代码或重新编译内核。



2.6.1  实验目的
验证eBPF在数据链路层的抓取效能，比较其与传统抓取工具的性能差异，并分析其对特定流量模式的捕获精度。
2.6.2  实验步骤
(1)流量生成：使用流量生成工具（如iperf或hping3）在目标服务器和另一台机器之间生成网络流量。确保生成的流量包含各种数据包大小和流量模式。
(2)eBPF流量抓取：启动eBPF程序，让其在数据链路层抓取流量。在实验期间，定期从eBPF map中提取数据，并保存到磁盘上进行后续分析。
(3)传统工具流量抓取：使用tcpdump在数据链路层抓取流量，并保存到pcap文件中。分析pcap文件，提取与eBPF程序相同的元数据。
(4)结果比较与分析：比较eBPF和tcpdump捕获的数据包数量，确保二者数据一致。分析两种方法的CPU和内存使用情况，以评估其性能。分析从eBPF map和pcap文件中提取的数据，评估抓取精度和可靠性。
三、 现阶段存在的问题
3.1 实验结论
在本次研究中，进行了实验以评估报头字段和数据字段在流量识别中的重要性。在实验一中，报头字段与数据字段被分别置为0，随后执行流量识别任务。根据实验数据，保留数据报头字段的识别率是90%，而仅保留数据字段的识别率是70%。这些数据表明，在流量识别中，报头字段的重要性相对于数据字段来说是更高的。

在实验二中，采用Resnet网络对数据进行训练，并计算每个特征的shapley值。根据所计算的shapley值，特征被按照其重要性进行排序。结果表明，报头字段中的前20个特征包括：TCP 16位源端口号、IP标识、MAC源地址、IP目的地址、IP首部校验、TCP选项字段、MAC目的地址 2、IP目的地址、TCP 16位窗口大小、以及TCP 32位序列号和IP数据包总长度。这些特征根据其shapley值的大小被识别为流量识别中的关键字段。
在基于eBPF在数据链路层抓取流量实验中，eBPF在数据链路层的抓取效能将显著优于传统的抓取工具，尤其在高流量条件下。此外，eBPF提供了更高的抓取精度和可靠性，特别是对于短暂和突发的流量模式。
3.2 存在的问题
在流量识别中，使用IP地址和端口号作为关键识别指标经常受到多种因素的影响，从而面临不少的限制和挑战。首先，动态IP分配是一个主要的障碍。大量的网络服务提供商（ISPs）为用户采用这种方式，导致用户的IP地址可能会不断变化，进一步降低了基于IP的流量识别的稳定性和可靠性。其次，网络地址转换（NAT）也对流量识别带来挑战。特别是在家庭和企业网络环境中，由于多台设备可能共享同一个公共IP地址，仅通过IP地址进行流量识别难以精确区分各设备。这是因为NAT机制会将这些设备的私有IP地址转换为一个公共的外部IP地址。再者，端口重用也增加了识别的复杂性。尽管某些应用和服务往往有默认的端口（例如HTTP的80端口），但实际上应用程序可以在任何可用端口上运行，进一步模糊了流量的来源和性质。综上得出方案一不可靠。
四、 下一步工作计划和内容


五、 已取得研究成果
无
